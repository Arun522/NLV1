name: Deploy to Production

on:
  push:
    branches: [ master, main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.js'
      - 'tailwind.config.js'
      - 'Dockerfile'
      - 'nginx.conf'
      - 'ecosystem.config.js'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Pre-deployment checks
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Run linting
      run: npm run lint
      
    - name: Security audit
      run: npm audit --audit-level high
      continue-on-error: true

  # Deploy via Docker to VPS
  deploy-production:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    environment:
      name: production
      url: https://nextmaze.in
      
    steps:
    - name: Deploy to Production VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || '22' }}
        script: |
          set -e
          
          echo "ğŸš€ Starting NextMaze Landing Production Deployment..."
          echo "ğŸ“… Deployment Time: $(date)"
          echo "ğŸ” Commit: ${{ github.sha }}"
          
          # Create deployment directory if it doesn't exist
          mkdir -p /var/www/nextmaze-landing
          cd /var/www/nextmaze-landing
          
          # Clone/pull latest code from GitHub
          if [ -d ".git" ]; then
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin master
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/Arun522/NextmazeLanding-V1.git .
          fi
          
          # Build Docker image directly on VPS
          echo "ğŸ”¨ Building Docker image..."
          docker build -t nextmaze-landing:latest .
          
          # Stop existing container
          echo "â¹ï¸ Stopping existing container..."
          docker stop nextmaze-landing || true
          docker rm nextmaze-landing || true
          
          # Run new container
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name nextmaze-landing \
            --restart unless-stopped \
            -p 80:80 \
            -e NODE_ENV=production \
            nextmaze-landing:latest
          
          # Wait for application to be ready
          echo "â³ Waiting for application to start..."
          sleep 30
          
          # Health check with retries
          echo "ğŸ¥ Performing health checks..."
          RETRIES=0
          MAX_RETRIES=10
          
          while [ $RETRIES -lt $MAX_RETRIES ]; do
            if curl -f -s -H "Host: nextmaze.in" http://localhost --max-time 10 > /dev/null 2>&1; then
              echo "âœ… Health check passed! Application is running."
              break
            else
              RETRIES=$((RETRIES + 1))
              echo "âš ï¸ Health check attempt $RETRIES/$MAX_RETRIES failed, retrying in 10s..."
              sleep 10
            fi
          done
          
          if [ $RETRIES -eq $MAX_RETRIES ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts!"
            echo "ğŸ“‹ Container logs:"
            docker logs nextmaze-landing --tail 50
            
            echo "ğŸ”„ Attempting rollback to previous version..."
            docker-compose down
            
            # Try to restore backup if available
            BACKUP_IMAGE=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep nextmaze-landing:backup | head -1)
            if [ ! -z "$BACKUP_IMAGE" ]; then
              echo "ğŸ“¦ Restoring backup: $BACKUP_IMAGE"
              docker tag $BACKUP_IMAGE nextmaze-landing:current
              docker-compose up -d
              sleep 20
              
              if curl -f -s http://localhost --max-time 10 > /dev/null 2>&1; then
                echo "âœ… Rollback successful"
                exit 1  # Exit with error to mark deployment as failed
              else
                echo "âŒ Rollback also failed"
                exit 1
              fi
            else
              echo "âŒ No backup available for rollback"
              exit 1
            fi
          fi
          
          # Final verification
          echo "ğŸ” Final deployment verification..."
          
          # Check container status
          if ! docker ps | grep nextmaze-landing | grep -q "Up"; then
            echo "âŒ Container is not running properly"
            docker ps -a | grep nextmaze-landing
            exit 1
          fi
          
          # Check website response
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Host: nextmaze.in" http://localhost --max-time 10)
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Website is responding correctly (HTTP $RESPONSE)"
          else
            echo "âš ï¸ Website response: HTTP $RESPONSE"
          fi
          
          # Cleanup old images and containers
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
          docker container prune -f
          
          # Log successful deployment
          echo "ğŸ“ Logging deployment..."
          echo "$(date '+%Y-%m-%d %H:%M:%S') - Deployment successful - Commit: ${{ github.sha }}" >> /var/log/nextmaze-deployments.log
          
          echo ""
          echo "ğŸ‰ NextMaze Landing deployed successfully!"
          echo "ğŸŒ Website: https://nextmaze.in"
          echo "ğŸ“Š Container Status:"
          docker ps | grep nextmaze-landing
          echo ""
          
  # Send deployment notification
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-production]
    if: always()
    
    steps:
    - name: Deployment Status Summary
      run: |
        if [ "${{ needs.deploy-production.result }}" = "success" ]; then
          echo "ğŸ‰ âœ… DEPLOYMENT SUCCESSFUL!"
          echo "ğŸŒ NextMaze Landing is now live at: https://nextmaze.in"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "â° Time: $(date)"
        else
          echo "âŒ DEPLOYMENT FAILED!"
          echo "ğŸ” Check the deployment logs for details"
          echo "ğŸ“ Commit: ${{ github.sha }}"
        fi